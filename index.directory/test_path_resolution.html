<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Path Resolution</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff88;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #00ff88;
      border-radius: 5px;
    }
    .success { color: #00ff88; }
    .error { color: #ff0055; }
    button {
      background: #00ff88;
      color: #1a1a1a;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 3px;
    }
    button:hover {
      background: #00cc6e;
    }
    pre {
      background: #0d0d0d;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Path Resolution Test Suite</h1>
  <p>This test validates that path resolution works correctly for notes.html and books.html</p>
  
  <div class="test-section">
    <h2>Test 1: Fetch notes-index.json</h2>
    <button onclick="testNotesIndex()">Run Test</button>
    <pre id="notes-index-result">Not run yet</pre>
  </div>
  
  <div class="test-section">
    <h2>Test 2: Fetch books-index.json</h2>
    <button onclick="testBooksIndex()">Run Test</button>
    <pre id="books-index-result">Not run yet</pre>
  </div>
  
  <div class="test-section">
    <h2>Test 3: Fetch a note markdown file</h2>
    <button onclick="testNoteFetch()">Run Test</button>
    <pre id="note-fetch-result">Not run yet</pre>
  </div>
  
  <div class="test-section">
    <h2>Test 4: Check image path resolution</h2>
    <button onclick="testImagePath()">Run Test</button>
    <pre id="image-path-result">Not run yet</pre>
  </div>
  
  <script>
    // Helper to apply path cleaning logic
    function cleanFilePath(filepath) {
      let cleanPath = filepath.replace(/^\/+/, '');
      if (cleanPath.startsWith('index.directory/')) {
        cleanPath = cleanPath.substring('index.directory/'.length);
      }
      return './' + cleanPath;
    }
    
    function cleanImagePath(imgPath) {
      let cleanSrc = imgPath.replace(/^\/+/, '');
      if (cleanSrc.startsWith('../')) {
        cleanSrc = cleanSrc.substring(3);
      }
      return './' + cleanSrc;
    }
    
    async function testNotesIndex() {
      const resultEl = document.getElementById('notes-index-result');
      resultEl.textContent = 'Testing...';
      
      try {
        const response = await fetch('./notes-index.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        resultEl.innerHTML = `<span class="success">✓ SUCCESS</span>
Loaded ${data.notes.length} notes
First note: ${data.notes[0].title}
File path: ${data.notes[0].file}
Cleaned path: ${cleanFilePath(data.notes[0].file)}`;
      } catch (error) {
        resultEl.innerHTML = `<span class="error">✗ FAILED</span>
Error: ${error.message}`;
      }
    }
    
    async function testBooksIndex() {
      const resultEl = document.getElementById('books-index-result');
      resultEl.textContent = 'Testing...';
      
      try {
        const response = await fetch('./books-index.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        resultEl.innerHTML = `<span class="success">✓ SUCCESS</span>
Loaded ${data.books.length} books
First book: ${data.books[0].title}
File path: ${data.books[0].file}
Cleaned path: ${cleanFilePath(data.books[0].file)}`;
      } catch (error) {
        resultEl.innerHTML = `<span class="error">✗ FAILED</span>
Error: ${error.message}`;
      }
    }
    
    async function testNoteFetch() {
      const resultEl = document.getElementById('note-fetch-result');
      resultEl.textContent = 'Testing...';
      
      try {
        // First get the notes index
        const indexResponse = await fetch('./notes-index.json');
        if (!indexResponse.ok) throw new Error('Could not fetch notes-index.json');
        const data = await indexResponse.json();
        
        // Get first note
        const firstNote = data.notes[0];
        const cleanPath = cleanFilePath(firstNote.file);
        
        // Try to fetch the note
        const noteResponse = await fetch(cleanPath);
        if (!noteResponse.ok) throw new Error(`HTTP ${noteResponse.status}`);
        const markdown = await noteResponse.text();
        
        resultEl.innerHTML = `<span class="success">✓ SUCCESS</span>
Note file: ${firstNote.title}
Original path: ${firstNote.file}
Cleaned path: ${cleanPath}
Content length: ${markdown.length} bytes
First 100 chars: ${markdown.substring(0, 100)}...`;
      } catch (error) {
        resultEl.innerHTML = `<span class="error">✗ FAILED</span>
Error: ${error.message}`;
      }
    }
    
    async function testImagePath() {
      const resultEl = document.getElementById('image-path-result');
      resultEl.textContent = 'Testing...';
      
      try {
        // Get notes index
        const indexResponse = await fetch('./notes-index.json');
        if (!indexResponse.ok) throw new Error('Could not fetch notes-index.json');
        const data = await indexResponse.json();
        
        // Find a note with a thumbnail
        const noteWithThumb = data.notes.find(n => n.thumbnail);
        if (!noteWithThumb) throw new Error('No notes with thumbnails found');
        
        // Test markdown image path (simulating ../assets/... from markdown)
        const markdownImagePath = '../assets/sfti.notez.assets/7.step.framework.assets/Step.1.png';
        const cleanedImagePath = cleanImagePath(markdownImagePath);
        
        // Try to load the image
        const img = new Image();
        img.onload = () => {
          resultEl.innerHTML = `<span class="success">✓ SUCCESS</span>
Thumbnail from index: ${noteWithThumb.thumbnail}
Markdown path: ${markdownImagePath}
Cleaned path: ${cleanedImagePath}
Image loaded: ${img.width}x${img.height}px`;
        };
        img.onerror = () => {
          resultEl.innerHTML = `<span class="error">✗ FAILED</span>
Could not load image: ${cleanedImagePath}`;
        };
        img.src = cleanedImagePath;
        
      } catch (error) {
        resultEl.innerHTML = `<span class="error">✗ FAILED</span>
Error: ${error.message}`;
      }
    }
  </script>
</body>
</html>
